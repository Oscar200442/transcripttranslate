import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { YoutubeTranscript } from "youtube-transcript";

const languages = [
  { code: "es", name: "Spanish" },
  { code: "fr", name: "French" },
  { code: "de", name: "German" },
  { code: "it", name: "Italian" },
  { code: "pt", name: "Portuguese" },
  { code: "ru", name: "Russian" },
  { code: "ja", name: "Japanese" },
  { code: "ko", name: "Korean" },
  { code: "zh", name: "Chinese" },
  { code: "ar", name: "Arabic" },
  { code: "hi", name: "Hindi" },
  { code: "nl", name: "Dutch" },
  { code: "sv", name: "Swedish" },
  { code: "no", name: "Norwegian" },
  { code: "da", name: "Danish" },
  { code: "fi", name: "Finnish" },
  { code: "pl", name: "Polish" },
  { code: "tr", name: "Turkish" },
  { code: "th", name: "Thai" },
  { code: "vi", name: "Vietnamese" },
];

function Home() {
  const [videoUrl, setVideoUrl] = useState("");
  const [selectedLanguage, setSelectedLanguage] = useState("");
  const [originalTranscript, setOriginalTranscript] = useState("");
  const [translatedText, setTranslatedText] = useState("");
  const [summary, setSummary] = useState("");
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  const extractVideoId = (url: string) => {
    const regex =
      /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/).*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
  };

  const fetchTranscript = async () => {
    if (!videoUrl) {
      setError("Please enter a YouTube video URL");
      return;
    }

    const videoId = extractVideoId(videoUrl);
    if (!videoId) {
      setError("Invalid YouTube URL");
      return;
    }

    setLoading(true);
    setError("");

    try {
      const transcript = await YoutubeTranscript.fetchTranscript(videoId);
      const fullTranscript = transcript.map((item) => item.text).join(" ");
      setOriginalTranscript(fullTranscript);
    } catch (err) {
      setError(
        "Failed to fetch transcript. Make sure the video has captions available.",
      );
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const translateText = async () => {
    if (!originalTranscript || !selectedLanguage) {
      setError("Please fetch transcript and select a language first");
      return;
    }

    setLoading(true);
    setError("");

    try {
      // Using Google Translate API (free tier)
      const response = await fetch(
        `https://api.mymemory.translated.net/get?q=${encodeURIComponent(originalTranscript)}&langpair=en|${selectedLanguage}`,
      );
      const data = await response.json();

      if (data.responseStatus === 200) {
        setTranslatedText(data.responseData.translatedText);
      } else {
        setError("Translation failed. Please try again.");
      }
    } catch (err) {
      setError("Translation service unavailable. Please try again later.");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const summarizeText = async () => {
    const textToSummarize = translatedText || originalTranscript;
    if (!textToSummarize) {
      setError("No text available to summarize");
      return;
    }

    setLoading(true);
    setError("");

    try {
      // Simple extractive summarization - taking first few sentences
      const sentences = textToSummarize
        .split(/[.!?]+/)
        .filter((s) => s.trim().length > 0);
      const summaryLength = Math.min(3, Math.ceil(sentences.length * 0.3));
      const summarizedText = sentences.slice(0, summaryLength).join(". ") + ".";
      setSummary(summarizedText);
    } catch (err) {
      setError("Failed to generate summary");
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-4">
      <div className="max-w-6xl mx-auto space-y-6">
        <Card className="bg-white">
          <CardHeader>
            <CardTitle className="text-2xl font-bold text-center">
              YouTube Transcript Translator
            </CardTitle>
            <CardDescription className="text-center">
              Extract, translate, and summarize YouTube video transcripts
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="flex gap-2">
              <Input
                placeholder="Enter YouTube video URL..."
                value={videoUrl}
                onChange={(e) => setVideoUrl(e.target.value)}
                className="flex-1"
              />
              <Button onClick={fetchTranscript} disabled={loading}>
                {loading ? "Loading..." : "Get Transcript"}
              </Button>
            </div>

            <div className="flex gap-2">
              <Select
                value={selectedLanguage}
                onValueChange={setSelectedLanguage}
              >
                <SelectTrigger className="flex-1">
                  <SelectValue placeholder="Select target language" />
                </SelectTrigger>
                <SelectContent>
                  {languages.map((lang) => (
                    <SelectItem key={lang.code} value={lang.code}>
                      {lang.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Button
                onClick={translateText}
                disabled={loading || !originalTranscript}
              >
                {loading ? "Translating..." : "Translate"}
              </Button>
              <Button
                onClick={summarizeText}
                disabled={loading || (!originalTranscript && !translatedText)}
              >
                {loading ? "Summarizing..." : "Summarize"}
              </Button>
            </div>

            {error && (
              <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                {error}
              </div>
            )}
          </CardContent>
        </Card>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <Card className="bg-white">
            <CardHeader>
              <CardTitle>Original Transcript</CardTitle>
            </CardHeader>
            <CardContent>
              <Textarea
                value={originalTranscript}
                readOnly
                placeholder="Original transcript will appear here..."
                className="min-h-[300px] resize-none"
              />
            </CardContent>
          </Card>

          <Card className="bg-white">
            <CardHeader>
              <CardTitle>Translated Text</CardTitle>
            </CardHeader>
            <CardContent>
              <Textarea
                value={translatedText}
                readOnly
                placeholder="Translated text will appear here..."
                className="min-h-[300px] resize-none"
              />
            </CardContent>
          </Card>
        </div>

        {summary && (
          <Card className="bg-white">
            <CardHeader>
              <CardTitle>Summary</CardTitle>
            </CardHeader>
            <CardContent>
              <Textarea
                value={summary}
                readOnly
                placeholder="Summary will appear here..."
                className="min-h-[150px] resize-none"
              />
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}

export default Home;
